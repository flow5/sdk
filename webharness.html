<html>

<head>

	<script src='require.js'></script>	
	<script src='jsext.js'></script>

	<script src='utils.js'></script>

	<script src='flow.js'></script>
	<script src='flow_diags.js'></script>		
	<script src='flowcontroller.js'></script>
	
	<script src='flowharness.js'></script>
		
	<script src='flows/basic_flow.js'></script>		
	<script src='flows/minimal_flow.js'></script>		
</head>

<body>
	<script>
		/*global theFlowController:true theFlow:true*/
		
		var Utils = require('./utils.js');	
		var FlowHarness = require('./flowharness.js').FlowHarness;
		
		function getURLParams() {
			var params = {};
			window.location.search.substring(1).split('&').forEach(function (pair) {
				params[pair.split('=')[0]] = pair.split('=')[1];
			});			
			return params;
		}
		
		try {
			var flowHarness = new FlowHarness(getURLParams().flowFile, function (flowController, flow) {
				theFlowController = flowController;
				theFlow = flow;				
				
				Utils.post('dot2svg', flow.toDOT(), function (response) {
					
					function makeClick(el) {
						el.onclick = function () {	
							try {
								var parts = el.id.split('-');
								var fullPath = parts[0];
								var method = parts[1];

								var components = fullPath.split('.');
								var nodePath = components[0];
								var id = components.reverse()[0];	
								
								flowController[method](flow.getNode(nodePath), id);																
							} catch (e) {
								console.log('Exception: ' + e.message);
							}													

						};
					}
					if (typeof document !== 'undefined') {
						document.body.innerHTML = response;

						document.body.style['background-color'] = 'darkslategray';
						document.body.style['text-align'] = 'center';

						// Make the main poly the same color as background
						// OPTION: would be nice to do this on the DOT side
						document.getElementById('graph1').querySelector('polygon').setAttribute('fill', 'darkslategray');
						document.getElementById('graph1').querySelector('polygon').setAttribute('stroke', '');

						// the clickable elements have id with / prefix
						var clickable = document.querySelectorAll('[id^="/"]');
						for (var i = 0; i < clickable.length; i += 1) {
							makeClick(clickable[i]);
						}
						
						document.getElementById('back-button').onclick = function () {
							try {
								flowController.doBack();								
							} catch (e) {
								console.log('Exception: ' + e.message);
							}
						};
					}
				});
			});
		} catch (e) {
			document.body.innerHTML = e.message;
		}
			
	</script>
</body>

</html>