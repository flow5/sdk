<html>

<head>
	
	<script>
		function getURLParams() {
			var params = {};
			window.location.search.substring(1).split('&').forEach(function (pair) {
				params[pair.split('=')[0]] = pair.split('=')[1];
			});			
			return params;
		}
	</script>

	<script src='Iuppiter.js'></script>

	<script src='require.js'></script>	
	<script src='jsext.js'></script>
	
	<script src='utils.js'></script>

	<script src='flow.js'></script>
	<script src='flow_diags.js'></script>		
	<script src='flowcontroller.js'></script>
	
	<script src='flowharness.js'></script>
				
	<script>
		/*jslint evil: true*/
		document.write('<script src="apps/' + getURLParams().app + '/flowspec.js"><\/script>');
	</script>
</head>

<body>
	<script>
		/*global theFlowController:true theFlow:true*/
		
		var Utils = require('./utils.js');	
		var FlowHarness = require('./flowharness.js').FlowHarness;		
		
		try {
			// function is called back on each action that changes flow state
			var flowHarness = new FlowHarness(function (flowController, flow, cb) {
				// make these global for the console
				theFlowController = flowController;
				theFlow = flow;				
				
				Utils.post('dot2svg', flow.toDOT(), function (response) {
					
					function makeClick(el) {
						el.onclick = function () {	
							try {
								var parts = el.id.split('-');
								var fullPath = parts[0];
								var method = parts[1];

								var components = fullPath.split('.');
								var nodePath = components[0];
								var id = components.reverse()[0];	
								
								flowController[method](flow.getNode(nodePath), id);																
							} catch (e) {
								console.log('Exception: ' + e.message);
							}													

						};
					}
					if (typeof document !== 'undefined') {
						document.body.innerHTML = response;

						document.body.style['background-color'] = 'darkslategray';
						document.body.style['text-align'] = 'center';

						// Make the main poly the same color as background
						// OPTION: would be nice to do this on the DOT side
						document.getElementById('graph1').querySelector('polygon').setAttribute('fill', 'darkslategray');
						document.getElementById('graph1').querySelector('polygon').setAttribute('stroke', '');

						// the clickable elements have id with / prefix
						var clickable = document.querySelectorAll('[id^="/"]');
						for (var i = 0; i < clickable.length; i += 1) {
							makeClick(clickable[i]);
						}
						
						document.getElementById('back-button').onclick = function () {
							try {
								flowController.doBack();								
							} catch (e) {
								console.log('Exception: ' + e.message);
							}
						};
					}
					
					cb();
				});
			});
		} catch (e) {
			document.body.innerHTML = e.message;
		}
			
	</script>
</body>

</html>