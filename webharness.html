<html>

<head>
	
	<script>
		function getURLParams() {
			var params = {};
			window.location.search.substring(1).split('&').forEach(function (pair) {
				params[pair.split('=')[0]] = pair.split('=')[1];
			});			
			return params;
		}
	</script>

	<script src='Iuppiter.js'></script>

	<script src='require.js'></script>	
	<script src='jsext.js'></script>

	<link rel="stylesheet" type="text/css" href="json.css">
	<script src='json.js'></script>
	
	<script src='utils.js'></script>

	<script src='flow.js'></script>
	<script src='flow_diags.js'></script>		
	<script src='flowcontroller.js'></script>
	
	<script src='flowharness.js'></script>
				
	<script>
		/*jslint evil: true*/
		document.write('<script src="apps/' + getURLParams().app + '/flowspec.js"><\/script>');
	</script>
</head>

<body>
	<script>
		/*global theFlowController:true theFlow:true*/
		
		var Utils = require('./utils.js');	
		var FlowHarness = require('./flowharness.js').FlowHarness;		
		var JSONFormatter = require('./json.js').JSONFormatter;
		
		try {
			// function is called back on each action that changes flow state
			var flowHarness = new FlowHarness(function (flowController, flow, cb) {
				// make these global for the console
				theFlowController = flowController;
				theFlow = flow;	
				
				Utils.post('dot2svg', flow.diags.toDOT(), function (response) {

					function makeClick(el) {
						el.onclick = function () {	
							try {
								var parts = el.id.split('-');
								var fullPath = parts[0];
								var method = parts[1];

								if (method) {
									var components = fullPath.split('.');
									var nodePath = components[0];
									var id = components.reverse()[0];	

									flowController[method](flow.diags.getNodeFromPath(nodePath), id);										
								}
							} catch (e) {
								console.log('Exception: ' + e.message);
							}													

						};
					}
					function setStyles(el, styles) {
						styles.forEach(function (id, value) {
							el.style[id] = value;
						});
					}
					if (typeof document !== 'undefined') {
						document.body.innerHTML = response;

						document.body.style['background-color'] = 'darkslategray';
						document.body.style['text-align'] = 'center';
						document.body.style['margin-left'] = '100px';

						// Make the main poly the same color as background
						// OPTION: would be nice to do this on the DOT side
						document.getElementById('graph1').querySelector('polygon').setAttribute('fill', 'darkslategray');
						document.getElementById('graph1').querySelector('polygon').setAttribute('stroke', '');

						// the clickable elements have id with / prefix
						var clickable = document.querySelectorAll('[id^="/"]');
						for (var i = 0; i < clickable.length; i += 1) {
							makeClick(clickable[i]);
						}

						// determine the offset of the current node
						var activeLeafNode = flow.diags.getActiveLeafNode();
						var svgElementBBox = document.getElementById(activeLeafNode.diags.path).getBBox();
						var svgRootBBox = document.querySelector('svg').getBBox();
						var offset = {x: svgElementBBox.x, y: svgRootBBox.height + svgElementBBox.y};

						// scroll it into view
						var tmp = document.createElement('div');
						tmp.style.position = 'absolute';
						tmp.style.top = offset.y + 'px';
						tmp.style.left = offset.x + 'px';
						document.body.appendChild(tmp);
						tmp.scrollIntoView();
						document.body.removeChild(tmp);

						// make the back button
						var backButton = document.createElement('div');
						setStyles(backButton, {
							'background-color': flowController.hasBack() ? 'lightblue' : 'grey',
							'display': '-webkit-box',
							'-webkit-box-pack': 'center',
							'-webkit-box-align': 'center',
							'position': 'fixed',
							'top': '0px',
							'left': '0px',
							'border': '4px solid ' + (flowController.hasBack() ? 'blue' : 'black'),
							'height': '40px',
							'width': '80px',
							'margin': '10px',
							'-webkit-border-radius': '14px',
							'font-size': '24px'												
						});
						backButton.innerText = '<==';	
						backButton.addEventListener('click', function () {
							try {
								flowController.doBack();								
							} catch (e) {
								console.log('Exception: ' + e.message);
							}
						});				
						document.body.appendChild(backButton);
						
						var jsonDiv;
						
						var jsonButton = document.createElement('div');
						setStyles(jsonButton, {
							'background-color': 'grey',
							'display': '-webkit-box',
							'-webkit-box-pack': 'center',
							'-webkit-box-align': 'center',
							'position': 'fixed',
							'top': '50px',
							'left': '0px',
							'border': '4px solid black',
							'height': '40px',
							'width': '80px',
							'margin': '10px',
							'-webkit-border-radius': '14px',
							'font-size': '24px'												
						});
						jsonButton.innerText = 'JSON';	
						
						jsonButton.addEventListener('click', function () {
							if (jsonDiv) {
								document.body.removeChild(jsonDiv);
								jsonDiv = null;
							} else {
								try {
									var jsonFormatter = new JSONFormatter();
									jsonDiv = document.createElement('div');
									setStyles(jsonDiv, {
										position: 'absolute',
										top: '10px',
										left: '200px',
										'text-align': 'left',
										'white-space': 'nowrap',
										'background-color': 'white',
										opacity: 0.65,
										border: '1px solid black'
									});
									jsonDiv.innerHTML = jsonFormatter.valueToHTML(JSON.parse(flow.diags.toJSON()));

									document.body.appendChild(jsonDiv);
									jsonFormatter.attachListeners();																
								} catch (e) {
									console.log('Exception: ' + e.message);
								}	
							}
							setStyles(jsonButton, {
								'background-color': jsonDiv ? 'lightblue' : 'grey',
								'border': '4px solid ' + (jsonDiv ? 'blue' : 'black')								
							});							
						});				
						document.body.appendChild(jsonButton);
						
					}

					cb();
				});					
			});
		} catch (e) {
			document.body.innerHTML = e.message;
		}
			
	</script>
</body>

</html>